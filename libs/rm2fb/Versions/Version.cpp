#include "Version.h"

#include <array>
#include <cstring>
#include <iomanip>
#include <iostream>
#include <map>

namespace {
// xxd -s 384 -l 20 -i xochitl
using BuildId = std::array<unsigned char, 20>;

const AddressInfoBase*
getAddresses(BuildId version) {
  static const std::map<BuildId, const AddressInfoBase*> addresses = {
    { { 0x93, 0x88, 0x6b, 0x15, 0xc3, 0xf5, 0x05, 0x12, 0x04, 0x9e,
        0xf2, 0x50, 0xc3, 0x20, 0xae, 0x00, 0x2a, 0x96, 0x5b, 0x05 },
      version_2_15_1 },

    { { 0x5c, 0x36, 0xb5, 0xbc, 0x41, 0xd9, 0xca, 0x8e, 0x77, 0x72,
        0x0d, 0xa6, 0x4d, 0x37, 0x91, 0x73, 0x70, 0x40, 0xfe, 0x1e },
      version_3_3_2 },

    { { 0x2e, 0xe6, 0x56, 0xd2, 0x5e, 0x17, 0xaf, 0x73, 0x96, 0x44,
        0x18, 0x0c, 0xf4, 0x7c, 0x0a, 0xd2, 0xf1, 0xd0, 0x3a, 0xe1 },
      version_3_5_2 },

    { { 0x31, 0xf4, 0xe9, 0xe8, 0x52, 0xaf, 0x39, 0x38, 0x15, 0xd8,
        0x14, 0xcd, 0xd3, 0xac, 0xb6, 0xdf, 0xbd, 0xc8, 0xb5, 0x67 },
      version_3_8_2 },

    { { 0xdd, 0xa7, 0x95, 0x11, 0x84, 0xf6, 0x05, 0xfa, 0x2e, 0x23,
        0x7f, 0xa7, 0x03, 0x81, 0xe8, 0x7d, 0x46, 0x5b, 0xdc, 0xd9 },
      version_3_8_2 }, // TODO

    { { 0x4f, 0xa0, 0xe9, 0x51, 0x3d, 0x15, 0x53, 0xf3, 0x4d, 0xdc,
        0x89, 0xba, 0x65, 0xbd, 0xd5, 0x69, 0x92, 0x92, 0x93, 0x9a },
      version_3_20_0 },
  };

  auto it = addresses.find(version);
  if (it == addresses.end()) {
    return nullptr;
  }

  return it->second;
}

} // namespace

const AddressInfoBase*
getAddresses() {
  static const AddressInfoBase* result = [] {
    BuildId id;

    // NOLINTNEXTLINE
    memcpy(id.data(), reinterpret_cast<const char*>(0x10180), id.size());

    std::cerr << "Build ID: ";
    for (unsigned char c : id) {
      std::cerr << "0x" << std::hex << std::setfill('0') << std::setw(2)
                << int(c) << " ";
    }
    std::cerr << "\n";
    return getAddresses(id);
  }();
  return result;
}
